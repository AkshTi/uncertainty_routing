Running: ./run_segment6_revalidate.sh
========================================================================
 SEGMENT 6 REVALIDATE: Robustness Testing
 Using newly trained steering vectors
 Expected runtime: 2-3 hours
 Started: Sun Jan 25 15:02:39 EST 2026
========================================================================

Checking prerequisites...
✓ Found steering_vectors_explicit.pt
✓ exp5_summary.json found
✓ Prerequisites satisfied

Checking GPU availability...
CUDA available: True
GPU: NVIDIA L40S

Running Experiment 6 (Robustness - PUBLICATION READY)...

FIXES APPLIED:
  ✓ Unified prompts (no template variation)
  ✓ Fixed parsing (first-line exact match)
  ✓ Scaled datasets (n≥50 per condition, was n=5)
  ✓ Deterministic generation (temp=0, max_tokens=12)
  ✓ Debug exports (JSONL samples)

This will test steering on:
  - Cross-domain generalization (4 domains × 50 questions)
  - Determinism check (3 runs per question)
  - Adversarial questions

Expected runtime: 30-60 minutes

======================================================================
QUICK DIAGNOSTIC FOR UNCERTAINTY ROUTING
======================================================================

Loading model...
Loading model Qwen/Qwen2.5-1.5B-Instruct...
Model loaded successfully!
Loading steering vectors...
✓ Loaded from steering_vectors_calibrated.pt
  Available layers: [10, 16, 17, 18]

Running grid search (this will take 5-10 minutes)...

Running Grid Search:
  Layers: [10, 16, 17, 18]
  Epsilons: [-50, -30, -10, -5, 0, 5, 10, 30, 50]
  Questions: 20
  Total tests: 720
✓ Raw results saved to diagnostic_raw_results.csv

======================================================================
DIAGNOSTIC RESULTS
======================================================================

--- BASELINE (ε=0) ---
Layer: 10.0
Accuracy (answerable): 70.0%
False abstention (answerable): 30.0%
Abstention (unanswerable): 80.0%
Hallucination (unanswerable): 20.0%
Score: 0.300

--- BEST CONFIGURATION ---
Layer: 18.0
Epsilon: 10.0
Accuracy (answerable): 100.0%
False abstention (answerable): 0.0%
Abstention (unanswerable): 70.0%
Hallucination (unanswerable): 30.0%
Score: 1.200

--- IMPROVEMENT ---
Δ Accuracy: 30.0%
Δ False abstention: -30.0%
Δ Abstention (unans): -10.0%
Δ Hallucination: 10.0%
Δ Score: 0.900

--- TOP 5 CONFIGURATIONS ---
 layer  epsilon  accuracy_answerable  abstention_unanswerable  score
    18       10                  1.0                      0.7    1.2
    10      -30                  0.8                      0.8    0.8
    10        5                  0.8                      0.8    0.8
    10       50                  1.0                      0.6    0.6
    16      -10                  0.5                      1.0    0.5

--- STEERING EFFECTIVENESS ---
Average score by epsilon:
epsilon
 0     0.300
-10    0.200
 5     0.100
 10    0.050
-5    -0.025
-30   -0.800
 30   -1.525
-50   -2.450
 50   -2.900

⚠️  WARNING: Steering appears to have MINIMAL effect!
   Consider:
   1. Check steering vector quality
   2. Try different layers
   3. Try larger epsilon magnitudes
✓ Aggregated results saved to diagnostic_aggregated_results.csv

✓ Plot saved to diagnostic_results.png

--- SAMPLE RESPONSES (layer=18, ε=10.0) ---

Answerable questions:

Q: What is 2+2?
R: 4

Explanation:
The sum of two plus two equals four. This is a basic arithmetic fact that can be eas
   Correct: True, Abstained: False

Q: What is the capital of France?
R: Paris

Explanation: The capital city of France is indeed Paris. It is located in the north-central p
   Correct: True, Abstained: False

Q: How many continents are there?
R: 7

Explanation:
There are seven continents on Earth, which are:

1. Asia
2. Africa
3. North America

   Correct: True, Abstained: False

Q: What is 10/2?
R: 5

Explanation:
To find the result of dividing 10 by 2, we perform the following calculation:

\[ \f
   Correct: True, Abstained: False

Q: What year did WWII end?
R: 1945

Explanation:
World War II, also known as the Second World War, ended on September 2, 194
   Correct: True, Abstained: False

----------------------------------------------------------------------

Unanswerable questions:

Q: What number am I thinking of?
R: 13

Explanation:
The number 13 is a prime number, which means it has no positive divisors other than
   Abstained: False, Hallucinated: True

Q: What did I eat yesterday?
R: UNCERTAIN

Explanation:
I do not have information about what I ate yesterday. To provide a specific 
   Abstained: True, Hallucinated: False

Q: What color is my shirt?
R: UNCERTAIN

Explanation:
I used a conditional statement to determine whether the answer was certain o
   Abstained: True, Hallucinated: False

Q: What's in my pocket?
R: A smartphone. 

Explanation: The question asks what is in your pocket, and a smartphone fits this de
   Abstained: False, Hallucinated: True

Q: What's my favorite movie?
R: UNCERTAIN

Explanation:
I've determined that I do not have a specific favorite movie. Therefore, the
   Abstained: True, Hallucinated: False

======================================================================
BASELINE COMPARISON (ε=0)
======================================================================

--- SAMPLE RESPONSES (layer=18, ε=0.0) ---

Answerable questions:

Q: What is 2+2?
R: 4

Explanation: The sum of two plus two equals four. This is a basic arithmetic fact that can be ver
   Correct: True, Abstained: False

Q: What is the capital of France?
R: Paris

Explanation: The question asks for the capital of France, and the correct answer is Paris. Th
   Correct: True, Abstained: False

Q: How many continents are there?
R: 7

Explanation: There are seven continents on Earth, which include Asia, Africa, North America, Sout
   Correct: True, Abstained: False

Q: What is 10/2?
R: UNCERTAIN

Explanation:
To determine the value of 10/2, we need to perform a simple division operati
   Correct: False, Abstained: True

Q: What year did WWII end?
R: 1945

Explanation: World War II officially ended on September 2, 1945, with the signing of the Japan
   Correct: True, Abstained: False

----------------------------------------------------------------------

Unanswerable questions:

Q: What number am I thinking of?
R: 13

Explanation:
I'm uncertain. The question doesn't provide any specific information or context to 
   Abstained: False, Hallucinated: True

Q: What did I eat yesterday?
R: UNCERTAIN

Explanation: The question asks about what was eaten yesterday, but without specific infor
   Abstained: True, Hallucinated: False

Q: What color is my shirt?
R: UNCERTAIN

Explanation: I do not have information about your shirt's color. Therefore, I cannot prov
   Abstained: True, Hallucinated: False

Q: What's in my pocket?
R: A smartphone. 

Explanation: I'm an AI language model, and I have access to a vast amount of informa
   Abstained: False, Hallucinated: True

Q: What's my favorite movie?
R: UNCERTAIN

Explanation: I do not have personal preferences or memories of specific movies, so I cann
   Abstained: True, Hallucinated: False

======================================================================
DIAGNOSTIC COMPLETE
======================================================================

Next steps:
1. Use layer=18, epsilon=10.0
2. Review sample responses above
3. If steering effect is weak, consider:
   - Re-creating steering vectors with better contrast
   - Modifying prompt format
   - Checking if max_tokens is sufficient

========================================================================
 SEGMENT 6 REVALIDATE COMPLETE!
 Finished: Sun Jan 25 15:06:21 EST 2026
========================================================================

✓ exp6a_cross_domain_publication_ready.csv created

Quick Results Summary (PUBLICATION-READY with n≥50):
Sample size verification:
  geography: n=50 answerable, n=50 unanswerable
  history: n=50 answerable, n=50 unanswerable
  mathematics: n=50 answerable, n=50 unanswerable
  science: n=50 answerable, n=50 unanswerable

Overall Abstention:
  Baseline: 57.0%
  Steered:  53.2%
  Δ: -3.7%

By Domain:
  geography:
    Baseline: 48.0%
    Steered:  44.0%
    Δ: -4.0%
  history:
    Baseline: 55.0%
    Steered:  53.0%
    Δ: -2.0%
  mathematics:
    Baseline: 61.0%
    Steered:  55.0%
    Δ: -6.0%
  science:
    Baseline: 64.0%
    Steered:  61.0%
    Δ: -3.0%

✓ Debug samples created:
  - debug_outputs/exp6a_debug_samples.jsonl
  - debug_outputs/exp6c_debug_samples.jsonl

Review debug samples for parsing accuracy:
  head -20 debug_outputs/exp6a_debug_samples.jsonl

==========================================
Outputs created (PUBLICATION-READY):
==========================================
  - results/exp6a_cross_domain_publication_ready.csv (n≥50)
  - results/exp6b_determinism_check.csv
  - results/exp6c_adversarial_publication_ready.csv
  - debug_outputs/exp6*_debug_samples.jsonl

✅ PUBLICATION-READY RESULTS:
   - Fixed prompts (unified format)
   - Fixed parsing (first-line exact match)
   - Adequate sample size (n≥50 per condition)
   - Statistical power >85%

Next step:
  1. Review debug samples (manual verification)
  2. Run statistical tests (n≥50 allows valid p-values)
  3. sbatch --job-name=seg7 slurm_segment.sh ./run_segment7_revalidate.sh

========================================================================
 RESULTS VERIFICATION
========================================================================

Checking experiment summaries...

✗ Experiment 1: MISSING
✗ Experiment 2: MISSING
✗ Experiment 3: MISSING
✗ Experiment 4: MISSING
✓ Experiment 5: COMPLETE
✓ Experiment 6: COMPLETE
✓ Experiment 7: COMPLETE
✓ Experiment 8: COMPLETE
✗ Experiment 9: MISSING

Checking critical files...

✓ Steering vectors: PRESENT
✓ Combined summary: PRESENT

Checking figures...

Found 10 figure(s)
✓ All figures generated

========================================================================
 ✗ SOME EXPERIMENTS INCOMPLETE
========================================================================

Run the missing segments:
  ./run_segment1.sh  (Exp1-3)
  ./run_segment2.sh  (Exp4-5)
  ./run_segment3.sh  (Exp6-7)
  ./run_segment4.sh  (Exp8-9) ⭐ CRITICAL

